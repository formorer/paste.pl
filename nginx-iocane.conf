server {
    # Replace with your actual listen and server_name directives
    listen 80;
    server_name example.com;

    # Enable recursive error pages to handle the 421 redirect internally
    recursive_error_pages on;

    location / {
        # Forward requests to Iocaine first (exposed on port 8923)
        proxy_pass http://127.0.0.1:8923;

        # Pass the Host header so Iocaine can log/inspect correctly
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Do not cache responses from the bot filter
        proxy_cache off;

        # Intercept errors to catch the 421 status code
        proxy_intercept_errors on;
        
        # If Iocaine returns 421 (Misdirected Request), it means "Allow", so go to the real backend
        error_page 421 = @backend;
    }

    location @backend {
        # Forward valid requests to the actual App (exposed on port 3000)
        proxy_pass http://127.0.0.1:3000;

        # Standard proxy headers for the backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
